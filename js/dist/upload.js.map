{"version":3,"file":"upload.js","sources":["../src/upload.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable camelcase */\nimport Toast from './toast'\nimport Tool from './tool'\nimport Util from './util'\n\nconst NAME = 'upload'\nconst METHOD = 'post'\nconst FILENAME = 'file'\nconst VERSION = '1.0.0'\nconst URL = 'http://127.0.0.1/file/upload'\nconst URL_MULTI = 'http://127.0.0.1/file/uploads'\n\n/**\n *  @author lyc\n *  @date 2020年08月23日16:15:25\n */\nclass Upload {\n  constructor(element) {\n    this._element = element\n    this._upload = this._init()\n    return this\n  }\n\n  static get NAME() {\n    return NAME\n  }\n\n  static get VERSION() {\n    return VERSION\n  }\n\n  _init() {\n    // eslint-disable-next-line no-undef\n    if (!Dropzone) {\n      throw new TypeError('Dropzone is not load, plz check out')\n    }\n    // 上传图片\n    let ele = this._element\n    if (!ele) {\n      return\n    }\n    if (Array.isArray(ele)) {\n      for (const key in ele) {\n        if (!Object.prototype.hasOwnProperty.call(ele, key)) {\n          continue\n        }\n        let item = key\n        if (!Util.isElement(item)) {\n          item = document.querySelector(item)\n        }\n        item.id = item.id ? item.id : `upload_${new Date().getTime()}`\n        this.uploadinit(item)\n      }\n      return\n    } else if (typeof ele === 'string') {\n      ele = document.querySelector(ele)\n    }\n    if (Util.isElement(ele)) {\n      ele.id = ele.id ? ele.id : `upload_${new Date().getTime()}`\n      this.uploadinit(ele)\n    }\n  }\n\n  uploadinit(ele) {\n    // 使用 https://www.dropzonejs.com/\n    // eslint-disable-next-line no-undef\n    Dropzone.options.myAwesomeDropzone = false\n    // eslint-disable-next-line no-undef\n    Dropzone.autoDiscover = false\n\n    const Multiple = ele.hasAttribute('multiple')\n    const Accept = ele.getAttribute('accept') || 'image/*,.jpg,.gif,.png,.svg,'\n    const url = Multiple ? URL_MULTI : URL\n    // 多选时 指定最大文件数为9 否则为1\n    const nine = 9\n    const maxFiles = Multiple ? nine : 1\n    const options = { // 实例化一个Dropzone上传对象\n      url,\n      acceptedFiles: Accept, // 上传的类型\n      uploadMultiple: Multiple, // 是否允许多文件上传\n      method: METHOD,  // 默认post\n      paramName: FILENAME, // 默认为file\n      maxFiles, // 一次性上传的文件数量上限\n      maxFilesize: 20, // MB\n      timeout: 10000, // 以毫秒为单位\n      parallelUploads: 3, // 并行处理多少个文件上载\n      createImageThumbnails: false, // 是否应生成图像的缩略图\n      dictMaxFilesExceeded: '您最多只能上传10个文件！',\n      dictResponseError: '文件上传失败!',\n      dictInvalidFileType: '你不能上传该类型文件,文件类型只能是*.jpg,*.gif,*.png。',\n      dictFallbackMessage: '浏览器不受支持',\n      dictFileTooBig: '文件过大上传文件最大支持.'\n    }\n    // eslint-disable-next-line no-undef\n    const dropzone = new Dropzone(ele, options)\n    const suc = Tool.eval(ele.getAttribute('data-suc'))\n    if (typeof suc === 'function') {\n      this._suc = suc\n    }\n    const chk = Tool.eval(ele.getAttribute('data-chk'))\n    if (typeof chk === 'function') {\n      this._chk = chk\n    }\n\n    // 将文件添加到列表时\n    dropzone.on('addedfile', this.fileAdded(this))\n    // 文件上传成功的时候触发\n    dropzone.on('success', this.fileSuc(this))\n    // 上传出错的时候触发\n    dropzone.on('error', () => {\n      Toast.err('文件上传失败')\n    })\n    return dropzone\n  }\n\n  fileAdded(uploader) {\n    return (files) => {\n      const preview = uploader._element.querySelector('.dz-preview')\n      if (preview) {\n        preview.remove()\n      }\n      let flag = true\n      // 检查失败\n      if (uploader._chk && typeof uploader._chk === 'function' && !uploader._chk(files)) {\n        flag = false\n      }\n      return flag\n    }\n  }\n\n  fileSuc(uploader) {\n    return (files, response) => {\n      let fr\n      if (!Tool.isJSON(response)) {\n        Toast.err('文件上传失败')\n        return\n      }\n      if (response.data) {\n        fr = response.data\n      }\n\n      if (uploader._suc && typeof uploader._suc === 'function') {\n        uploader._suc(fr, uploader._element)\n      }\n    }\n  }\n}\n\nexport default Upload\n"],"names":["NAME","METHOD","FILENAME","VERSION","URL","URL_MULTI","Upload","element","_element","_upload","_init","Dropzone","TypeError","ele","Array","isArray","key","Object","prototype","hasOwnProperty","call","item","Util","isElement","document","querySelector","id","Date","getTime","uploadinit","options","myAwesomeDropzone","autoDiscover","Multiple","hasAttribute","Accept","getAttribute","url","nine","maxFiles","acceptedFiles","uploadMultiple","method","paramName","maxFilesize","timeout","parallelUploads","createImageThumbnails","dictMaxFilesExceeded","dictResponseError","dictInvalidFileType","dictFallbackMessage","dictFileTooBig","dropzone","suc","Tool","eval","_suc","chk","_chk","on","fileAdded","fileSuc","Toast","err","uploader","files","preview","remove","flag","response","fr","isJSON","data"],"mappings":"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"}