{"version":3,"file":"upload.js","sources":["../src/upload.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable camelcase */\nimport Toast from './toast'\nimport Tool from './tool'\nimport Util from './util'\n\nconst NAME                = 'upload'\nconst VERSION             = '1.0.0'\nconst URL                 = 'http://127.0.0.1/file/upload'\nconst URL_MULTI           = 'http://127.0.0.1/file/uploads'\n\n/**\n *  @author lyc\n *  @date 2020年08月23日16:15:25\n */\nclass Upload {\n  constructor(element) {\n    this._element = element\n    this._upload = this._init()\n  }\n\n  static get NAME() {\n    return NAME\n  }\n\n  static get VERSION() {\n    return VERSION\n  }\n\n  _init() {\n    // eslint-disable-next-line no-undef\n    if (!plupload) {\n      throw new TypeError('plupload is not load, plz check out')\n    }\n    // 上传图片\n    let ele = this._element\n    if (!ele) {\n      return\n    }\n    if (Array.isArray(ele)) {\n      for (const key in ele) {\n        if (!Object.prototype.hasOwnProperty.call(ele, key)) {\n          continue\n        }\n        let item = key\n        if (!Util.isElement(item)) {\n          item = document.querySelector(item)\n        }\n        item.id = item.id ? item.id : `upload_${new Date().getTime()}`\n        this.uploadinit(item)\n      }\n      return\n    } else if (typeof ele === 'string') {\n      ele = document.querySelector(ele)\n    }\n    if (Util.isElement(ele)) {\n      ele.id = ele.id ? ele.id : `upload_${new Date().getTime()}`\n      this.uploadinit(ele)\n    }\n  }\n  uploadinit(ele) {\n    // eslint-disable-next-line no-undef\n    const loader = new plupload.Uploader({ // 实例化一个plupload上传对象\n      runtimes: 'html5,html4,flash,silverlight',\n      browse_button: ele,\n      url: URL,\n      filters: {\n        max_file_size: '10mb',\n        mime_types: [\n          {\n            title: 'Image files',\n            extensions: 'jpg,gif,png,svg'\n          },\n          {\n            title: 'Zip files',\n            extensions: 'zip'\n          }\n        ]\n      }\n    })\n    const suc = Tool.eval(ele.getAttribute('data-suc'))\n    if (typeof suc === 'function') {\n      loader._suc = suc\n    }\n    const chk = Tool.eval(ele.getAttribute('data-chk'))\n    if (typeof chk === 'function') {\n      loader._chk = chk\n    }\n    // 用户选择文件时触发\n    loader.bind('FilesAdded', this.fileAdded)\n    // 文件上传成功的时候触发\n    loader.bind('FileUploaded', this.fileSuc)\n    // 上传出错的时候触发\n    loader.bind('Error', () => {\n      Toast.err('文件上传失败')\n    })\n    loader.init()\n    return loader\n  }\n\n  fileAdded(uploader, files) {\n    // 检查失败\n    if (uploader._chk && typeof uploader._chk === 'function' && !uploader._chk(files)) {\n      for (const file in files) {\n        if (!Object.prototype.hasOwnProperty.call(files, file)) {\n          continue\n        }\n        uploader.removeFile(file)\n      }\n      return\n    }\n    // 当选择的文件大于1 时候更改上传url\n    uploader.setOption('url', files.length > 1 ? URL_MULTI : URL)\n    uploader.start() // 开始上传\n  }\n\n  fileSuc(uploader, _file, responseObject) {\n    let fr\n    const datas = JSON.parse(responseObject.response)\n    if (datas && datas.data) {\n      fr = datas.data\n    }\n    if (uploader._suc && typeof uploader._suc === 'function') {\n      uploader._suc(fr)\n    }\n  }\n}\n\nexport default Upload\n"],"names":["NAME","VERSION","URL","URL_MULTI","Upload","element","_element","_upload","_init","plupload","TypeError","ele","Array","isArray","key","Object","prototype","hasOwnProperty","call","item","Util","isElement","document","querySelector","id","Date","getTime","uploadinit","loader","Uploader","runtimes","browse_button","url","filters","max_file_size","mime_types","title","extensions","suc","Tool","eval","getAttribute","_suc","chk","_chk","bind","fileAdded","fileSuc","Toast","err","init","uploader","files","file","removeFile","setOption","length","start","_file","responseObject","fr","datas","JSON","parse","response","data"],"mappings":"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"}